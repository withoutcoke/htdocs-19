var gpxParser=function(){this.xmlSource="",this.metadata={},this.waypoints=[],this.tracks=[],this.routes=[]};gpxParser.prototype.parse=function(e){var t=this,a=new DOMParser;if(this.xmlSource=a.parseFromString(e,"text/xml"),metadata=this.xmlSource.querySelector("metadata"),null!=metadata){this.metadata.name=this.getElementValue(metadata,"name"),this.metadata.desc=this.getElementValue(metadata,"desc"),this.metadata.time=this.getElementValue(metadata,"time");var l={},r=metadata.querySelector("author");if(null!=r){l.name=this.getElementValue(r,"name"),l.email={};var n=r.querySelector("email");null!=n&&(l.email.id=n.getAttribute("id"),l.email.domain=n.getAttribute("domain"));var i={};null!=(s=r.querySelector("link"))&&(i.href=s.getAttribute("href"),i.text=this.getElementValue(s,"text"),i.type=this.getElementValue(s,"type")),l.link=i}this.metadata.author=l;var s;i={};null!=(s=metadata.querySelector("link"))&&(i.href=s.getAttribute("href"),i.text=this.getElementValue(s,"text"),i.type=this.getElementValue(s,"type"),this.metadata.link=i)}var u=[].slice.call(this.xmlSource.querySelectorAll("wpt"));for(var o in u){var m=u[o];(b={}).name=t.getElementValue(m,"name"),b.lat=parseFloat(m.getAttribute("lat")),b.lon=parseFloat(m.getAttribute("lon")),b.ele=parseFloat(t.getElementValue(m,"ele")),b.cmt=t.getElementValue(m,"cmt"),b.desc=t.getElementValue(m,"desc"),t.waypoints.push(b)}var c=[].slice.call(this.xmlSource.querySelectorAll("rte"));for(var o in c){var p=c[o],h={};h.name=t.getElementValue(p,"name"),h.cmt=t.getElementValue(p,"cmt"),h.desc=t.getElementValue(p,"desc"),h.src=t.getElementValue(p,"src"),h.number=t.getElementValue(p,"number"),h.link=t.getElementValue(p,"link"),h.type=t.getElementValue(p,"type");var g=[],v=[].slice.call(p.querySelectorAll("rtept"));for(var E in v){var y=v[E];(b={}).lat=parseFloat(y.getAttribute("lat")),b.lon=parseFloat(y.getAttribute("lon")),b.ele=parseFloat(t.getElementValue(y,"ele")),g.push(b)}h.distance=t.calculDistance(g),h.elevation=t.calcElevation(g),h.points=g,t.routes.push(h)}var V=[].slice.call(this.xmlSource.querySelectorAll("trk"));for(var o in V){var d=V[o],f={};f.name=t.getElementValue(d,"name"),f.cmt=t.getElementValue(d,"cmt"),f.desc=t.getElementValue(d,"desc"),f.src=t.getElementValue(d,"src"),f.number=t.getElementValue(d,"number"),f.link=t.getElementValue(d,"link"),f.type=t.getElementValue(d,"type");var x=[],S=[].slice.call(d.querySelectorAll("trkpt"));for(var E in S){var b,A=S[E];(b={}).lat=parseFloat(A.getAttribute("lat")),b.lon=parseFloat(A.getAttribute("lon")),b.ele=parseFloat(t.getElementValue(A,"ele")),x.push(b)}f.distance=t.calculDistance(x),f.elevation=t.calcElevation(x),f.points=x,t.tracks.push(f)}},gpxParser.prototype.getElementValue=function(e,t){var a=e.querySelector(" :scope > "+t);return null!=a?a.innerHTML:a},gpxParser.prototype.calculDistance=function(e){for(var t={},a=0,l=[],r=0;r<e.length-1;r++)a+=this.calcDistanceBetween(e[r],e[r+1]),l[r]=a;return l[e.length-1]=a,t.total=a,t.cumul=l,t},gpxParser.prototype.calcDistanceBetween=function(e,t){var a={};a.lat=e.lat,a.lon=e.lon;var l={};l.lat=t.lat,l.lon=t.lon;var r=Math.PI/180,n=a.lat*r,i=l.lat*r,s=Math.sin((l.lat-a.lat)*r/2),u=Math.sin((l.lon-a.lon)*r/2),o=s*s+Math.cos(n)*Math.cos(i)*u*u;return 6371e3*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))},gpxParser.prototype.calcElevation=function(e){for(var t=0,a=0,l={},r=0;r<e.length-1;r++){var n=parseFloat(e[r+1].ele)-parseFloat(e[r].ele);n<0?a+=n:0<n&&(t+=n)}for(var i=[],s=0,u=(r=0,e.length);r<u;r++){var o=parseFloat(e[r].ele);i.push(o),s+=o}return l.max=Math.max.apply(null,i),l.min=Math.min.apply(null,i),l.pos=Math.abs(t),l.neg=Math.abs(a),l.avg=s/i.length,l},gpxParser.prototype.isEmpty=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0};